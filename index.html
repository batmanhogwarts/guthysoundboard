<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>North Hollywood High School Fire Alarm Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600&display=swap" rel="stylesheet">
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Header -->
    <div class="header">
        <h1>North Hollywood High School Fire Alarm Tracker</h1>
        <p>Keeping track of fire alarm events at our school</p>
    </div>

    <!-- Statistics -->
    <div class="stats">
        <div class="stat">
            <h2 id="daysWithoutAlarm">--</h2>
            <p>Days Without a Fire Alarm</p>
        </div>
        <div class="stat">
            <h2 id="lastAlarmDate">--</h2>
            <p>Last Alarm Date</p>
        </div>
        <div class="stat">
            <h2 id="timeSinceLast">--</h2>
            <p>Elapsed Time Since Last Alarm</p>
        </div>
        <div class="stat">
            <h2 id="longestInterval">--</h2>
            <p>Longest Time Between Alarms</p>
        </div>
        <div class="stat">
            <h2 id="shortestInterval">--</h2>
            <p>Shortest Time Between Alarms</p>
        </div>
        <div class="stat">
            <h2 id="averageInterval">--</h2>
            <p>Average Time Between Alarms</p>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav">
        <button id="prevMonth">&lt;</button>
        <h2 id="calendarMonthYear">Month Year</h2>
        <button id="nextMonth">&gt;</button>
    </div>

    <!-- Calendar -->
    <div class="calendar-container">
        <div class="calendar" id="calendar">
            <!-- Calendar will be generated by JavaScript -->
        </div>
        <button id="currentMonthButton">Current Month</button>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2023 North Hollywood High School Fire Alarm Tracker</p>
    </div>

    <!-- JavaScript -->
    <script>
        let alarmTimes = [];
        let alarmMap = {};
        let displayMonth;
        let displayYear;

        // Fetch the data from data.json
        fetch('data.json')
        .then(response => response.json())
        .then(data => {
            // Process the data
            alarmTimes = data.times.map(datetimeStr => new Date(datetimeStr));
            alarmTimes.sort((a, b) => a - b); // Sort dates ascending

            // Update Statistics
            updateStatistics(alarmTimes);

            // Set the default display month and year to the last alarm month
            const lastAlarm = alarmTimes[alarmTimes.length - 1];
            displayMonth = lastAlarm.getMonth();
            displayYear = lastAlarm.getFullYear();

            // Generate Alarm Map
            generateAlarmMap();

            // Generate Calendar
            generateCalendar(displayMonth, displayYear);
        })
        .catch(error => console.error('Error fetching data:', error));

        function updateStatistics(alarmTimes) {
            const now = new Date();
            const lastAlarm = alarmTimes[alarmTimes.length - 1];

            // Days Without a Fire Alarm
            const daysWithout = Math.floor((now - lastAlarm) / (1000 * 60 * 60 * 24));
            document.getElementById('daysWithoutAlarm').innerText = daysWithout;

            // Last Alarm Date
            document.getElementById('lastAlarmDate').innerText = lastAlarm.toLocaleString();

            // Elapsed Time Since Last Alarm
            updateTimeSinceLastAlarm(lastAlarm);

            // Calculate intervals between alarms
            const intervals = [];
            for (let i = 1; i < alarmTimes.length; i++) {
                const diff = alarmTimes[i] - alarmTimes[i - 1];
                intervals.push(diff);
            }

            if (intervals.length > 0) {
                // Longest Interval
                const longestInterval = Math.max(...intervals);
                document.getElementById('longestInterval').innerText = formatDuration(longestInterval);

                // Shortest Interval
                const shortestInterval = Math.min(...intervals);
                document.getElementById('shortestInterval').innerText = formatDuration(shortestInterval);

                // Average Interval
                const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                document.getElementById('averageInterval').innerText = formatDuration(averageInterval);
            } else {
                document.getElementById('longestInterval').innerText = '--';
                document.getElementById('shortestInterval').innerText = '--';
                document.getElementById('averageInterval').innerText = '--';
            }
        }

        function updateTimeSinceLastAlarm(lastAlarm) {
            function updateCounter() {
                const now = new Date();
                const duration = now - lastAlarm;
                document.getElementById('timeSinceLast').innerText = formatDuration(duration);
            }

            updateCounter();
            setInterval(updateCounter, 1000);
        }

        function formatDuration(duration) {
            const seconds = Math.floor((duration / 1000) % 60);
            const minutes = Math.floor((duration / (1000 * 60)) % 60);
            const hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
            const days = Math.floor(duration / (1000 * 60 * 60 * 24));

            return `${days} days ${hours} hours ${minutes} minutes ${seconds} seconds`;
        }

        function generateAlarmMap() {
            // Group alarm times by date
            alarmMap = {};
            alarmTimes.forEach(alarm => {
                const dateKey = alarm.toISOString().split('T')[0];
                if (!alarmMap[dateKey]) {
                    alarmMap[dateKey] = [];
                }
                alarmMap[dateKey].push(alarm);
            });
        }

        function generateCalendar(month, year) {
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = ''; // Clear previous calendar

            // Update the calendar month and year display
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            document.getElementById('calendarMonthYear').innerText = `${monthNames[month]} ${year}`;

            // Create headers for the days of the week
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            for (let day of daysOfWeek) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('day', 'header');
                dayElement.innerText = day;
                calendarElement.appendChild(dayElement);
            }

            // Get the first day of the month
            const firstDay = new Date(year, month, 1).getDay();

            // Get the number of days in the month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Fill in the blanks before the first day
            for (let i = 0; i < firstDay; i++) {
                const blankElement = document.createElement('div');
                blankElement.classList.add('day');
                calendarElement.appendChild(blankElement);
            }

            // Fill in the days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = date.toISOString().split('T')[0];

                const dayElement = document.createElement('div');
                dayElement.classList.add('day');
                dayElement.innerText = day;

                // Check if this date is in the alarmMap
                if (alarmMap[dateKey]) {
                    const alarmCount = alarmMap[dateKey].length;

                    // Adjust the red color intensity based on the number of alarms
                    const redIntensity = Math.min(255, 100 + (alarmCount * 30));
                    dayElement.style.backgroundColor = `rgb(${redIntensity}, 0, 0)`;
                    dayElement.style.color = '#fff';
                    dayElement.style.fontWeight = '600';

                    // Add hover tooltip with times
                    const tooltip = document.createElement('div');
                    tooltip.classList.add('tooltip');
                    tooltip.innerHTML = alarmMap[dateKey]
                        .map(alarm => alarm.toLocaleTimeString())
                        .join('<br>');

                    dayElement.appendChild(tooltip);
                    dayElement.classList.add('has-tooltip');
                }

                calendarElement.appendChild(dayElement);
            }
        }

        // Event Listeners for Navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            if (displayMonth === 0) {
                displayMonth = 11;
                displayYear--;
            } else {
                displayMonth--;
            }
            generateCalendar(displayMonth, displayYear);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            if (displayMonth === 11) {
                displayMonth = 0;
                displayYear++;
            } else {
                displayMonth++;
            }
            generateCalendar(displayMonth, displayYear);
        });

        document.getElementById('currentMonthButton').addEventListener('click', () => {
            const now = new Date();
            displayMonth = now.getMonth();
            displayYear = now.getFullYear();
            generateCalendar(displayMonth, displayYear);
        });
    </script>
</body>
</html>
